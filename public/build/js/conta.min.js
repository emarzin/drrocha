$(document).ready(function() {
    function setCredentials(data) {
        storage.set({
            user: data.user
        }), storage.set({
            token: data.token
        }), $.ajaxSetup({
            headers: {
                Authorization: data.token
            }
        })
    }

    function startCountDown() {
        actualCount--;
        var btnSaveLabel = $("#btnSaveLabel");
        btnSaveLabel.text("Salvando. Aguarde..." + actualCount), actualCount < 0 && (btnSaveLabel.text("Salvando. Aguarde..."), clearInterval(counter))
    }
    var storage = Storages.localStorage;
    storage.isSet("token") ? ($("#name").val(storage.get("user").name), $("#cpf").val(storage.get("user").doc).mask("000.000.000-00", {
        reverse: !0
    }), $("#email").val(storage.get("user").email), $("#celular").val(storage.get("user").celular).mask("00 00000-0000", {
        reverse: !0
    })) : window.location.href = "/entrar", $("#btnSaveLabel").text("Salvar"), $("#btnSaveSpinner").hide();
    var counter, actualCount = 40;
    $("#btnSave").click(function() {
        var errEmail = $("#errEmail");
        errEmail.text("");
        var password = $("#password").val(),
            confirmPassword = $("#confirmPassword").val();
        if (password === confirmPassword) {
            $("#btnSave").prop("disabled", !0), $("#btnSaveSpinner").show(), counter = setInterval(startCountDown, 1e3);
            var data = {
                    name: $("#name").val(),
                    email: $("#email").val(),
                    celular: $("#celular").cleanVal(),
                    password: password,
                    confirmPassword: confirmPassword
                },
                update = $.ajax({
                    url: "/api/conta",
                    type: "PUT",
                    beforeSend: function(request) {
                        request.setRequestHeader("Authorization", storage.get("token"))
                    },
                    data: data
                });
            update.done(function(data) {
                clearInterval(counter), errEmail.text("Atualização completa! Aguarde..."), setCredentials(data), $("#btnSave").hide(), $("#btnGoBack").hide(), window.location.href = "/members?token=" + data.token
            }), update.fail(function(xhr, textStatus) {
                if (clearInterval(counter), actualCount = 40, $("#btnSaveSpinner").hide(), $("#btnSaveLabel").text("Salvar"), $("#btnSave").prop("disabled", !1), xhr.responseJSON && xhr.responseJSON.errors && xhr.responseJSON.errors.email && xhr.responseJSON.errors.email.message) errEmail.text(xhr.responseJSON.errors.email.message);
                else if (xhr.responseJSON && xhr.responseJSON.length > 0) {
                    for (var erro = "", i = 0; i < xhr.responseJSON.length; i++) erro = erro + "<br>" + xhr.responseJSON[i].msg;
                    errEmail.append(erro)
                } else errEmail.text(xhr.responseText)
            })
        } else errEmail.text("A confirmação da senha não confere! Verifique!")
    }), $("#btnGoBack").click(function() {
        window.location.href = "/members?token=" + storage.get("token")
    })
});