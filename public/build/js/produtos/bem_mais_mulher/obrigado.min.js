$(document).ready(function() {
    function setCredentials(data) {
        storage.set({
            user: data.user
        }), storage.set({
            token: data.token
        }), storage.set({
            member: data.user.email
        }), $.ajaxSetup({
            headers: {
                Authorization: data.token
            }
        })
    }

    function checkPurchase() {
        var data = {
                name: c_name,
                email: c_email,
                transaction: transaction,
                prod: "169108"
            },
            checkPurchase = $.ajax({
                url: "/api/checkpurchase",
                type: "GET",
                data: data
            });
        checkPurchase.done(function(data) {
            console.log(data), "ok" === data.status && (storage.removeAll(), setCredentials(data), window.location.href = "/bem-vindo?token=" + data.token)
        }), checkPurchase.fail(function(xhr, textStatus) {
            console.log(xhr.responseText), console.log(xhr.responseJSON)
        })
    }
    var storage = Storages.localStorage,
        q = function() {
            var hash, vars = [],
                q = decodeURIComponent(document.URL);
            if (void 0 !== (q = q.split("?")[1])) {
                q = q.split("&");
                for (var i = 0; i < q.length; i++) hash = q[i].split("="), vars.push(hash[1]), vars[hash[0]] = hash[1]
            }
            return vars
        }();
    console.log(q);
    var transaction = q.transaction,
        c_name = q.c_name,
        c_email = q.c_email;
    void 0 !== transaction ? storage.set({
        transaction: transaction
    }) : console.log(storage.isSet("transaction")) && (transaction = storage.get("transaction")), void 0 !== c_name ? storage.set({
        c_name: c_name
    }) : console.log(storage.isSet("c_name")) && (c_name = storage.get("c_name")), void 0 !== c_email ? storage.set({
        c_email: c_email
    }) : console.log(storage.isSet("c_email")) && (c_email = storage.get("c_email"));
    var countDown = 300,
        cmd = $("#cmd");
    new FlipClock($(".clock"), countDown, {
        countdown: !0,
        language: "portuguese",
        clockFace: "MinuteCounter",
        callbacks: {
            interval: function() {
                if (console.log(countDown), 0 === --countDown) return console.log("Postback nÃ£o chegou. Alertar cliente para aguardar dados por email e sms."), void cmd.show();
                0 === countDown % 5 && (console.log("check key"), checkPurchase())
            }
        }
    })
});